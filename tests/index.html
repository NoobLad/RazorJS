<!doctype html>
<html>
<head>
	<link href="http://code.jquery.com/qunit/qunit-git.css" rel="stylesheet" />
	<style>
		body {
			font-family: sans-serif;
		}
		pre {
			background: #f3f3f3;
			margin: 5px;
			padding: 5px;
		}
		h3 {
			padding: 0;
			margin: 1em 0 0 0;
		}
	</style>
</head>
<body>
	<h1 id="qunit-header">Razor</h1>
	<h2 id="qunit-banner"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>

	<script src="http://code.jquery.com/jquery-latest.js"></script>
	<script src="http://code.jquery.com/qunit/qunit-git.js"></script>
	<script src="../bin/browser/Razor.js"></script>

	<h2>Views</h2>

	<script>
		if (!String.prototype.trim)
			String.prototype.trim = function () {
				return this.replace(/^\s+|\s+$/g, '');
			};

		test('Basic Parsing', function () {
			equal(Razor.compile('@{ <a b=@0 c=@1> </a> }')().trim(), '<a b=0 c=1> </a>', 'multiple code snippets in a tag opener inside a code block');
			equal(Razor.compile('test\\test')().trim(), 'test\\test', '\\ needs to be double-encoded');

			equal(Razor.compile('@if(true) { if(true){ <a @(0>1?0:1) /> } }')().trim(), '<a 1 />', 'ternary inside tag inside nested if');
			equal(Razor.compile('@if(true) { if(true){ <a @(0>1?0:1) /> <a> </a> } }')().trim(), '<a 1 /><a> </a>', 'ternary inside tag inside nested if followed by another tag');

			equal(Razor.compile('@{ model.items.forEach(function(x){ @x }); }')({ items: [0] }), '0', 'forEach');
			equal(Razor.compile('test')(), 'test', 'no razor');
			equal(Razor.compile('test@test.com')(), 'test@test.com', 'email address');
			equal(Razor.compile('test@@@(model.test).com')({ test: 'test' }), 'test@test.com', 'explicit code');
			equal(Razor.compile('hello @model.name')({ name: 'world' }), 'hello world', 'model');
			equal(Razor.compile('hello @model.name[0]')({ name: 'world'.split('') }), 'hello w', 'model w/ indexers');
			equal(Razor.compile('hello @model.name("world")')({ name: function (n) { return n; } }), 'hello world', 'model w/ method');
			equal(Razor.compile('te@*FAIL*@st')(), 'test', 'comment');
			equal(Razor.compile('@if(model.name){ @model.name }')({ name: 'test' }), 'test', 'if statement');
			equal(Razor.compile('@if(!model.name){ @fail(); } else { @model.name; }')({ name: 'test' }), 'test', 'if-else statement');
			equal(Razor.compile('@if(true){ @:test }')().trim(), 'test', 'text-mode');
			equal(Razor.compile('@helper test(name){ @:Hi @name } @test("bob")')().trim(), 'Hi bob', 'helper');
			equal(Razor.compile('@if(true){ <div><div>nested</div></div>  }')().trim(), '<div><div>nested</div></div>', 'nested tags inside code');
			equal(Razor.compile('@{  }')().trim(), '', 'javascript code block');
			equal(Razor.compile('@if(true){ <text>hi</text> }')().trim(), 'hi', 'using <text/>');
			equal(Razor.compile('@if(true){ if(false) { @:fail } else { @:win } }')().trim(), 'win', 'nested if');
			equal(Razor.compile('@if(true){ if(false) { @:fail } else { <div>Hi!</div> if(false) { } <div>Hi!</div> } }')().trim(), '<div>Hi!</div><div>Hi!</div>', 'nested if w/ html');

			try {
				Razor.compile('@(');
			} catch (x) { 
				ok(!!x, 'Didn\'t crash the browser');
			}
			try {
				Razor.compile('@{');
			} catch (x) { 
				ok(!!x, 'Didn\'t crash the browser');
			}
		});

		test('Views', function () {
			equal(Razor.view('test-page-w-layout')().trim().split(/\s+/g).join('\n'), '<a>test!</a>\n<a>body!</a>', 'layouts');
			equal(Razor.view('basic-test')({ name: 'world' }).trim(), 'Hello world', 'basic "hello world"');
			equal(Razor.view('test-partial')({ name: 'world' }).trim(), 'Hello world', 'renderPartial');
			equal(Razor.view('test-helper')({}).trim(), '<div>Hello world</div>', 'complex helper');
			equal(Razor.view('test-less-than')({ id: -1 }).trim(), '<div>Ok!</div>', 'view contains "<"');
		});

		test('Html Encoding', function () {
			var encode = Razor.basePage.html.encode;
			equal(encode('<test>') + '', '&lt;test&gt;', 'encodes');
			equal(encode(encode('<test>')) + '', '&lt;test&gt;', 'won\'t double-encode');
			equal(Razor.compile('hello @html.raw("<test>")')(), 'hello <test>', 'won\'t encode for html.raw()');
		});

		test('To-Do', function(){
			equal(Razor.compile('@model.forEach(function(x){ @x })')([0]).trim(), '0', 'rendering from inside an inlined-function');
		});
	</script>

<script type="application/x-razor-js" data-view-id="basic-test">  
	Hello @model.name
</script>
<script type="application/x-razor-js" data-view-id="test-less-than">
	@if(model.id < 0) {
		<div>Ok!</div>
	}
</script>
<script type="application/x-razor-js" data-view-id="test-helper">
	@helper test(name){
		name = name || 'world';
		<div>Hello @name</div>
	}
	@test(model.name)
</script> 
<script type="application/x-razor-js" data-view-id="test-partial">
	@html.renderPartial('basic-test', model)
</script>

<script type="application/x-razor-js" data-view-id="test-layout">
	@page.renderSection('test')
	@page.renderBody()
</script>
<script type="application/x-razor-js" data-view-id="test-page-w-layout">
	@{
		page.layout = 'test-layout';
	}
	<a>body!</a>
	@section test(){
		<a>test!</a>
	}
</script>

<script>
	(function () {
		if(navigator.userAgent.indexOf('PhantomJS') > -1)
			return;

		$('script[data-view-id]').each(function(){
			var self = $(this),
				html = self.html().split('\t').join('  ');
			html = html.substr(html.indexOf('\n') + 1);
			$('<pre class="brush: razor">').text(html).insertAfter(self);
			$('<h3>').text(self.data('view-id')).insertAfter(self);
		});

		document.write('<link href="http://alexgorbatchev.com/pub/sh/3_0_83/styles/shCore.css" rel="stylesheet" />');
		document.write('<link href="http://alexgorbatchev.com/pub/sh/3_0_83/styles/shThemeDefault.css" rel="stylesheet" />');
		document.write('<script src="http://alexgorbatchev.com/pub/sh/3_0_83/scripts/shCore.js"></sc'+'ript>');
		document.write('<script src="shBrushRazor.js"></sc'+'ript>');
		document.write('<script src="http://alexgorbatchev.com/pub/sh/3_0_83/scripts/shBrushXml.js"></sc'+'ript>');
		
		setTimeout(function retry(){
			var sh = window.SyntaxHighlighter;
			if(
					!sh ||
					!sh.brushes.Xml ||
					!sh.brushes.Razor
				) return void setTimeout(retry, 100);

			sh.highlight();
		}, 1);
	})();
</script>
</body>
</html>
