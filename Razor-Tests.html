<!doctype html>
<html>
<head>
  <link href="http://code.jquery.com/qunit/qunit-git.css" rel="stylesheet" />
</head>
<body>
  <h1 id="qunit-header">Razor</h1>
  <h2 id="qunit-banner"></h2>
  <div id="qunit-testrunner-toolbar"></div>
  <h2 id="qunit-userAgent"></h2>
  <ol id="qunit-tests"></ol>

  <script src="http://code.jquery.com/jquery-latest.js"></script>
  <script src="http://code.jquery.com/qunit/qunit-git.js"></script>
  <script src="bin/browser/Razor.js"></script>
  <script>
    if (!String.prototype.trim)
    	String.prototype.trim = function () {
    		return this.replace(/^\s+|\s+$/g, '');
    	};

    test('Basic Parsing', function () {
    	equal(Razor.compile('test')(), 'test', 'no razor');
    	equal(Razor.compile('test@test.com')(), 'test@test.com', 'email address');
    	equal(Razor.compile('test@@@(model.test).com')({ test: 'test' }), 'test@test.com', 'explicit code');
    	equal(Razor.compile('hello @model.name')({ name: 'world' }), 'hello world', 'model');
    	equal(Razor.compile('hello @model.name[0]')({ name: 'world'.split('') }), 'hello w', 'model w/ indexers');
    	equal(Razor.compile('hello @model.name("world")')({ name: function (n) { return n; } }), 'hello world', 'model w/ method');
    	equal(Razor.compile('te@*FAIL*@st')(), 'test', 'comment');
    	equal(Razor.compile('@if(model.name){ @model.name }')({ name: 'test' }), 'test', 'if statement');
    	equal(Razor.compile('@if(!model.name){ @fail(); } else { @model.name; }')({ name: 'test' }), 'test', 'if-else statement');
    	equal(Razor.compile('@if(true){ @:test }')().trim(), 'test', 'text-mode');
    	equal(Razor.compile('@helper test(name){ @:Hi @name } @test("bob")')().trim(), 'Hi bob', 'helper');
      equal(Razor.compile('@if(true){ <div><div>nested</div></div>  }')().trim(), '<div><div>nested</div></div>', 'nested tags inside code');
      equal(Razor.compile('@{  }')().trim(), '', 'javascript code block');
      equal(Razor.compile('@if(true){ <text>hi</text> }')().trim(), 'hi', 'using <text/>');
      equal(Razor.compile('@if(true){ if(false) { @:fail } else { @:win } }')().trim(), 'win', 'nested if');
      equal(Razor.compile('@if(true){ if(false) { @:fail } else { <div>Hi!</div> } }')().trim(), '<div>Hi!</div>', 'nested if w/ html');

      try {
        Razor.compile('@(');
      } catch (x) { 
        ok(!!x, 'Didn\'t crash the browser');
      }
      try {
        Razor.compile('@{');
      } catch (x) { 
        ok(!!x, 'Didn\'t crash the browser');
      }
    });

    test('Views', function () {
    	equal(Razor.view('test')({ name: 'world' }).trim(), 'Hello world', 'basic "hello world"');
    	equal(Razor.view('test-partial')({ name: 'world' }).trim(), 'Hello world', 'renderPartial');
    	equal(Razor.view('test-helper')({}).trim(), '<div>Hello world</div>', 'complex helper');
    	equal(Razor.view('test-lt')({ id: -1 }).trim(), '<div>Ok!</div>', 'view contains "<"');
    });

    test('Html Encoding', function () {
    	var encode = Razor.basePage.html.encode;
    	equal(encode('<test>') + '', '&lt;test&gt;', 'encodes');
    	equal(encode(encode('<test>')) + '', '&lt;test&gt;', 'won\'t double-encode');
    	equal(Razor.compile('hello @html.raw("<test>")')(), 'hello <test>', 'won\'t encode for html.raw()');
    });
  </script>
  <script type="application/x-razor-js" data-view-id="test">  
    Hello @model.name
  </script>
  <script type="application/x-razor-js" data-view-id="test-lt">
    @if(model.id < 0) {
      <div>Ok!</div>
    }
  </script>
  <script type="application/x-razor-js" data-view-id="test-helper">
    @helper test(name){
      name = name || 'world';
      <div>Hello @name</div>
    }
    @test(model.name)
  </script> 
  <script type="application/x-razor-js" data-view-id="test-partial">
    @html.renderPartial('test', model)
  </script>
</body>
</html>
