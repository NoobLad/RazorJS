(function(){"use strict";function t(t){return t&&(t+"").indexOf("[native code]")>-1?t:void 0}function e(t){return f(arguments,function(e,n){0!==n&&e&&f(v(e),function(n){t[n]=e[n]})}),t}function n(t){return(t=t||"").substr(t.length-1)}function r(t){var e,o,u,s=new x(t),a=arguments[1]||0,l=arguments[2]||0,h=[],f=[],c=[];for(h.push=function(t){return function(e,n){"string"==typeof e&&(e=[e]),e=p(e,function(t){return t.code!==void 0?t:new k(t,n)}),t.apply(this,e)}}(h.push);!s.eof()&&(e=0===l?s.readUntil("@"):s.readQuotedUntil("@","<"));){for(;;){if(o=s.peek(),!o)break;if("@"===o&&(e.value+=s.read()),1===l&&"<"===e.next){var d=s.text.substr(s.position+1).match(/^[a-z]+(?:\:[a-z]+)?/i);if(!d){var v=s.readQuotedUntil("@","<");e.value+=e.next+v.value,e.next=v.next;continue}if(h.push(e.value,0),e=s.readUntil(">"),u=e+"","/"!==n(e.value)){var g,m=1;for(g={next:!0};m>0&&(g=s.readQuotedUntil(["</"+d,"<"+d]),u+=g,!s.eof());)m+="/"===g.next.substr(1,1)?-1:1;u+=s.readQuotedUntil(">")}h.push(r("<"+u,a+1,0))}else e.value&&(0===l?h.push(e.value,2):h.push(e.value));break}if("*"===o)s.readUntil("*@");else if("("===o)u=s.readBlock("(",")"),h.push(u.substr(1,u.length-2),1);else if("{"===o)u=s.readBlock("{","}"),h.push(r(u.substr(0,u.length-1),a+1,1).join("\n")+"}");else if(":"===o&&1===l){for(u=s.readUntil("\n","@");"@"===u.next&&"@"===s.peek(1);){var w=s.readUntil("\n","@");u.value+=w.value,u.next=w.next}u.value=u.value.substr(1),h.push(u.value.match(/(.*?)\s*$/)[1],2),h.push(u.value.match(/\s*$/)[0]||"",0)}else if("i"===o&&"if"===s.peek(2)||"d"===o&&"do"===s.peek(2)||"f"===o&&"for"===s.peek(3)||"w"===o&&"while"===s.peek(5)||"h"===o&&"helper"===s.peek(6)||"s"===o&&"section"===s.peek(7)){if(u=s.readBlock("{","}"),"i"===o)for(;!s.eof();){var j=s.readWhitespace();if(!j)break;if("else"!==s.peek(4)){s.seek(-j.length);break}u+=j+s.readBlock("{","}")}var U=r(u.substr(0,u.length-1),a+1,1).join("\n")+"}";"h"===o?f.push("function "+U.substr(7)):"s"===o?c.push("function _section_"+U.substr(8)):h.push(U)}else if(o&&!y.test(n(e.value))){var O,Q;for(u="";!s.eof()&&(O=s.text.substr(s.position+1),Q=O.match(y))&&(u+=s.read(Q[0].length),o=s.peek());)if("["===o||"("===o){u+=s.readBlock(o,"["===o?"]":")");break}u&&h.push(u,1)}else 0===l&&(e.next?h.push("@",2):h.push(e.value,2))}return a>0?h:(t=h.join("\r\n"),t=b.replace("#0",t).replace("#1",p(f,i).join("\r\n")).replace("#2",p(c,i).join("\r\n")))}function i(t){var e=t.indexOf("{");return t.substr(0,e+1)+"\r\n"+t.substring(e+1,t.lastIndexOf("}"))+'; return ""; }'}function o(t){return t.split("\r").join("\\r").split("\n").join("\\n").split('"').join('\\"')}function u(t){return{toString:function(){return t},isHtmlString:!0}}function s(t,n){var i,o=r(t);try{i=Function(o)}catch(u){throw global.console.error(u.message+": "+o),u.message+": "+o}return function(t,r){var o=e(r||{},j,n,{model:t,writer:[]});return i.apply(o)}}function a(t,e){var n=U["~/"+t];if(n)return O?g().resolve(n):n;var r=l.findView(t);if(r){if("function"==typeof r.done){O=!0;var i=g();return r.done(function(r){r&&(n=U["~/"+t]=l.compile(r,e)),i.resolve(n)}),i}return r?U["~/"+t]=l.compile(r,e):void 0}}var l,h=function(t){return function(e,n){return t.apply(e,[n])}},f=h(t(Array.prototype.forEach)||function(t,e){for(var n,r=this.length,i=r,o=e||global;i--;)t.apply(o,[this[n=r-i-1],n])}),p=h(t(Array.prototype.map)||function(t,e){for(var n=e||global,r=[],i=0,o=this.length;o>i;++i)r.push(t.call(n,this[i],i,this));return r}),c=h(t(Array.prototype.some)||function(t,e){for(var n=e||global,r=0,i=this.length;i>r;++r)if(t.call(n,this[r],r,this))return!0;return!1}),d="toString valueOf".split(" "),v=t(Object.keys)||function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(n);return f(d,function(n){t[n]!==Object.prototype[n]&&e.push(n)}),e},g=function m(){if(!(this instanceof m))return new m;var t,n=[],r=[],i=[],o=0,u=this,s=function(e,n){for(var r;n&&(r=e.shift());)r.apply(u,t)};e(u,{done:function(t){return t&&n.push(t),s(n,1===o),s(r,0!==o),u},always:function(t){return r.push(t),s(r,0!==o),u},fail:function(t){return t&&i.push(t),s(i,-1===o),s(r,0!==o),u},resolve:function(){return t=arguments,0===o&&(o=1),u.done()},reject:function(){return t=arguments,0===o&&(o=-1),u.fail()}})},x=function(){function t(t,e,r){function o(e){return u=e.length,l=s[u]||(s[u]=t.peek(u)),l===e}for(var u,s=[],a="",l="";!t.eof();){if(s.length=0,r===c(e,o))return r?t.seek(u):(l=n(a),a=a.length>0?a.substr(0,a.length-1):""),i.create(a,l);if(l=t.read(),!l)break;a+=l}return i.create(a,l)}var r=function(t){this.text=(t||"")+"",this.position=-1,this.length=this.text.length},i=r.Chunk=function(t,e){return this.value=t||"",this.next=e||"",t||e?(this.length=(this.value+this.next).length,void 0):""};return e(i.prototype,{length:0,toString:function(){return this.value+this.next+""}}),i.create=function(t,e){return t||e?new i(t,e):""},e(r.prototype,{eof:function(){return this.position>=this.length},read:function(t){var e=this.peek(t);return this.position=Math.min(this.length,this.position+(t||1)),e},readAll:function(){if(this.position>=this.length)return void 0;var t=this.text.substr(this.position+1);return this.position=this.length,t},peek:function(t){return this.position+1>=this.length?void 0:this.text.substr(this.position+1,t||1)},seek:function(t,e){return this.position=Math.max(0,Math.min(this.length,(0===e?0:2===e?this.length:this.position)+(t||1))),this.position===this.length},readUntil:function(e){return"string"==typeof e&&(e=[].slice.call(arguments)),t(this,e,!0)},readWhile:function(e){return"string"==typeof e&&(e=[].slice.call(arguments)),t(this,e,!1)}}),r}(),y=/^[a-z0-9\._]+/i;x.prototype.readWhitespace=function(){return this.readWhile("\r","\n","	"," ")},x.prototype.readQuoted=function(t){for(var e,r="";;){if(e=this.readUntil(t),!e)break;if(r+=e.value+e.next,"\\"!==n(e.value))break}return r},x.prototype.readQuotedUntil=function(t){var e,n="";for("string"==typeof t&&(t=[].slice.call(arguments)),t=['"',"'","@*"].concat(t);e=this.readUntil(t);)if(n+=e.value,'"'===e.next||"'"===e.next)n+=e.next+this.readQuoted(e.next);else{if("@*"!==e.next)break;this.readUntil("*@")}return x.Chunk.create(n,e.next)},x.prototype.readBlock=function(t,e,n){var r,i=[t,e],o="";for(n=n||0;r=this.readUntil(i);){if(o+=r.value,r.next===t?n++:r.next===e&&n--,0===n)return o+=r.next;o+=r.next}return o};var k=function(t,e){this.code=t||"",this.type=e||0};e(k.prototype,{type:0,code:"",toString:function(){var t=this.code;return 0===this.type?t:2===this.type?'page.writeLiteral("'+o(t)+'");':"page.write("+t+");"}});var b='var page = this, writer = page.writer, model = page.model, html = page.html\r\n#1\r\n#2\r\n#0\r\nreturn writer.join("");',w={encode:function(t){return(null===t||void 0===t)&&(t=""),t.isHtmlString?t:("string"!=typeof t&&(t+=""),t=t.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;"),w.raw(t))},attributeEncode:function(t){return w.encode(t)},raw:function(t){return u(t)},renderPartial:function(t,e){return this.raw(l.view(t)(e))}},j={html:w,write:function(t){this.writeLiteral(this.html.encode(t))},writeLiteral:function(t){this.writer.push(t)}},U={},O=!1;l={view:a,compile:s,parse:r,findView:null,basePage:j,Cmd:k,render:function(t,e,n){return s(t)(e,n)}},l.findView=function(t){var e=require("fs"),n=g();return".jshtml"!==t.substring(t.lastIndexOf("."))&&(t+=".jshtml"),e.readFile(t,"ascii",function(t,e){t&&(console.error("Could not open file: %s",t),process.exit(1)),n.resolve(e.toString("ascii"))}),n},module.Razor=module.exports.Razor=l})(module);