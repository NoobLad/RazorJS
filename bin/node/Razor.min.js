(function(){"use strict";function t(e){if(e&&e.toString().indexOf("[native code]")>-1)return e}function a(e){return r(arguments,function(t,n){if(n===0)return;t&&r(u(t),function(n){e[n]=t[n]})}),e}function h(e){return(e=e||"").substr(e.length-1)}function v(e,t){var n=new l(e),r=arguments[1]||0,s=arguments[2]||0,o=[],u=[],a=[],f,g,y;o.push=function(e){return function(t,n){typeof t=="string"&&(t=[t]),t=i(t,function(e){return typeof e.code!="undefined"?e:new p(e,n)}),e.apply(this,t)}}(o.push);for(;;){f=s===0?n.readUntil("@"):n.readQuotedUntil("@","<");if(!f||!f.value&&!f.next)break;for(;;){g=n.peek(),g==="@"&&(f.value+=n.read());if(s===1&&f.next==="<"){var b=n.text.substr(n.position+1).match(/^[a-z]+/i);if(!b){var w=n.readQuotedUntil("@","<");f.value+=f.next+w.value,f.next=w.next;continue}o.push(f.value,0),f=n.readUntil(">"),y=f+"",h(f.value)!=="/"&&(y+=n.readUntil("</"+b+">")),o.push(v("<"+y,r+1,0))}else f.value&&(s===0?o.push(f.value,2):o.push(f.value));break}if(g==="*")n.readUntil("*@");else if(g==="(")y=n.readBlock("(",")"),o.push(y.substr(1,y.length-2),1);else if(g==="{")y=n.readBlock("{","}"),o.push(v(y.substr(0,y.length-1),r+1,1).join("\n")+"}");else if(g===":"&&s===1){y=n.readUntil("\n","@");while(y.next==="@"&&n.peek(1)==="@"){var E=n.readUntil("\n","@");y.value+=E.value,y.next=E.next}y.value=y.value.substr(1),o.push(y.value.match(/(.*?)\s*$/)[1],2),o.push(y.value.match(/\s*$/)[0]||"",0)}else if(g==="i"&&n.peek(2)==="if"||g==="d"&&n.peek(2)==="do"||g==="f"&&n.peek(3)==="for"||g==="w"&&n.peek(5)==="while"||g==="h"&&n.peek(6)==="helper"||g==="7"&&n.peek(7)==="section"){y=n.readBlock("{","}");if(g==="i")for(;;){var S=n.readWhitespace();if(!S)break;if(n.peek(4)!=="else"){n.seek(-S.length);break}y+=S+n.readBlock("{","}")}var x=v(y.substr(0,y.length-1),r+1,1).join("\n")+"}";g==="h"?u.push("function "+x.substr(7)):g==="s"?a.push("function _section_"+x.substr(8)):o.push(x)}else if(g&&!c.test(h(f.value))){var T,N;y="";for(;;){T=n.text.substr(n.position+1),N=T.match(c);if(!N)break;y+=n.read(N[0].length),g=n.peek();if(g==="["||g==="(")y+=n.readBlock(g,g==="["?"]":")")}y&&o.push(y,1)}else s===0&&f.next&&o.push("@",2)}return r>0?o:(e=o.join("\r\n"),e=d.replace("#0",e).replace("#1",i(u,m).join("\r\n")).replace("#2",i(a,m).join("\r\n")),e)}function m(e){var t=e.indexOf("{");return e.substr(0,t+1)+"\r\n"+e.substring(t+1,e.lastIndexOf("}"))+'; return ""; }'}function g(e){return e.split("\r").join("\\r").split("\n").join("\\n").split('"').join('\\"')}function y(e){return{toString:function(){return e},isHtmlString:!0}}function E(e,t,n){var r,i=v(e,n);try{r=new Function(i)}catch(s){throw global.console.error(s.message+": "+i),s.message+": "+i}return function(e,n){var i=a(n||{},w,t,{model:e,writer:[]});return r.apply(i)}}function T(t,n){var r=S["~/"+t];if(!!r)return x?f().resolve(r):r;var i=e.findView(t);if(typeof i.done=="function"){x=!0;var s=f();return i.done(function(i){i&&(r=S["~/"+t]=e.compile(i,n)),s.resolve(r)}),s}if(i)return S["~/"+t]=e.compile(i,n)}var e,n=function(e){return function(t,n){return e.apply(t,[n])}},r=n(t(Array.prototype.forEach)||function(e,t){var n=this.length,r=n,i,s=t||global;while(r--)e.apply(s,[this[i=n-r-1],i])}),i=n(t(Array.prototype.map)||function(e,t){var n=t||global,r=[];for(var i=0,s=this.length;i<s;++i)r.push(e.call(n,this[i],i,this));return r}),s=n(t(Array.prototype.some)||function(e,t){var n=t||global;for(var r=0,i=this.length;r<i;++r)if(e.call(n,this[r],r,this))return!0;return!1}),o="toString valueOf".split(" "),u=t(Object.keys)||function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return r(o,function(n){e[n]!==Object.prototype[n]&&t.push(n)}),t},f=function N(){if(!(this instanceof N))return new N;var e=[],t=[],n=[],r=0,i=this,s,o=function(e,t){var n;while(t&&(n=e.shift()))n.apply(i,s)};a(i,{done:function(n){return n&&e.push(n),o(e,r===1),o(t,r!==0),i},always:function(e){return t.push(e),o(t,r!==0),i},fail:function(e){return e&&n.push(e),o(n,r===-1),o(t,r!==0),i},resolve:function(){return s=arguments,r===0&&(r=1),i.done()},reject:function(){return s=arguments,r===0&&(r=-1),i.fail()}})},l=function(){function n(e,n,r){function l(t){return i=t.length,f=o[i]||(o[i]=e.peek(i)),f===t}var i,o=[],u=n.length,a="",f="";for(;;){o.length=0;if(r===s(n,l))return r?e.seek(i):(f=h(a),a=a.length>0?a.substr(0,a.length-1):""),new t(a,f);f=e.read();if(!f)break;a+=f}return new t(a,f)}var e=function(e){this.text=(e||"")+"",this.position=-1,this.length=this.text.length},t=e.Chunk=function(e,t){this.value=e||"",this.next=t||"",this.length=(this.value+this.next).length};return a(t.prototype,{length:0,toString:function(){return this.value+this.next+""}}),e.prototype.read=function(e){var t=this.peek(e);return this.position=Math.min(this.length,this.position+(e||1)),t},e.prototype.readAll=function(){if(this.position>=this.length)return undefined;var e=this.text.substr(this.position+1);return this.position=this.length,e},e.prototype.peek=function(e){return this.position+1>=this.length?undefined:this.text.substr(this.position+1,e||1)},e.prototype.seek=function(e,t){return this.position=Math.max(0,Math.min(this.length,(t===0?0:t===2?this.length:this.position)+(e||1))),this.position===this.length},e.prototype.readUntil=function(e){return typeof e=="string"&&(e=[].slice.call(arguments)),n(this,e,!0)},e.prototype.readWhile=function(e){return typeof e=="string"&&(e=[].slice.call(arguments)),n(this,e,!1)},e}(),c=/^[a-z0-9\._]+/i;l.prototype.readWhitespace=function(){return this.readWhile("\r","\n","	"," ")},l.prototype.readQuoted=function(e){var t="",n;for(;;){n=this.readUntil(e);if(!n)break;t+=n.value+n.next;if(h(n.value)!=="\\")break}return t},l.prototype.readQuotedUntil=function(e){var t="",n;typeof e=="string"&&(e=[].slice.call(arguments)),e=['"',"'","@*"].concat(e);while(!!(n=this.readUntil(e))){t+=n.value;if(n.next==='"'||n.next==="'")t+=n.next+this.readQuoted(n.next);else{if(n.next!=="@*")break;this.readUntil("*@")}}return new l.Chunk(t,n.next)},l.prototype.readBlock=function(e,t,n){var r,i=[e,t],s="";n=n||0;while(!!(r=this.readUntil(i))){s+=r.value,r.next===e?n++:r.next===t&&n--;if(n===0)return s+=r.next,s;s+=r.next}return s};var p=function(e,t){this.code=e||"",this.type=t||0};a(p.prototype,{type:0,code:"",toString:function(){var e=this.code;return this.type===0?e:this.type===2?'page.writeLiteral("'+g(e)+'");':"page.write("+e+");"}});var d='var page = this, writer = page.writer, model = page.model, html = page.html\r\n#1\r\n#2\r\n#0\r\nreturn writer.join("");',b={encode:function(e){if(e===null||e===undefined)e="";return e.isHtmlString?e:(typeof e!="string"&&(e+=""),e=e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;"),b.raw(e))},attributeEncode:function(e){return b.encode(e)},raw:function(e){return y(e)},renderPartial:function(t,n){return this.raw(e.view(t)(n))}},w={html:b,write:function(e){this.writeLiteral(this.html.encode(e))},writeLiteral:function(e){this.writer.push(e)}},S={},x=!1;e={view:T,compile:E,parse:v,findView:null,basePage:w,Cmd:p,render:function(e,t,n){return E(e)(t,n)}},e.findView=function(t){var n=require("fs"),r=f();return t.substring(t.lastIndexOf("."))!==".jshtml"&&(t+=".jshtml"),n.readFile(t,"ascii",function(e,t){e&&(console.error("Could not open file: %s",e),process.exit(1)),r.resolve(t.toString("ascii"))}),r},module.Razor=module.exports.Razor=e})(module)