(function(){"use strict";function r(e){return(e=e||"")[e.length-1]||""}function o(e,a){var f=new t(e),l=arguments[1]||0,c=arguments[2]||0,h=[],p=[],d=[],v,m,g;h.push=function(e){return function(t,n){typeof t=="string"&&(t=[t]),t=t.map(function(e){return typeof e.code!="undefined"?e:new i(e,n)}),e.apply(this,t)}}(h.push);for(;;){v=c===0?f.readUntil("@"):f.readQuotedUntil("@","<");if(!v||!v.value&&!v.next)break;m=f.peek(),m==="@"&&(v.value+=f.read()),v.value&&(c===0?h.push(v.value,2):h.push(v.value));if(c===1&&v.next==="<"){var y=f.text.substr(f.position+1).match(/^[a-z]+/i);y&&(v=f.readUntil(">"),g=v+"",r(v.value)!=="/"&&(g+=f.readUntil("</"+y+">")),h.push(o("<"+g,l+1,0)))}if(m==="*")f.readUntil("*@");else if(m==="(")g=f.readBlock("(",")"),h.push(g.substr(1,g.length-2),1);else if(m==="{")g=f.readBlock("{","}"),h.push(o(g.substr(0,g.length-1),l+1,1).join("\n")+"}");else if(m===":"&&c===1){g=f.readUntil("\n","@");while(g.next==="@"&&f.peek(1)==="@"){var b=f.readUntil("\n","@");g.value+=b.value,g.next=b.next}g.value=g.value.substr(1),h.push(g.value.match(/(.*?)\s*$/)[1],2),h.push(g.value.match(/\s*$/)[0]||"",0)}else if(m==="i"&&f.peek(2)==="if"||m==="d"&&f.peek(2)==="do"||m==="f"&&f.peek(3)==="for"||m==="w"&&f.peek(5)==="while"||m==="h"&&f.peek(6)==="helper"||m==="7"&&f.peek(7)==="section"){g=f.readBlock("{","}");if(m==="i")for(;;){var w=f.readWhitespace();if(!w)break;if(f.peek(4)!=="else"){f.seek(-w.length);break}g+=w+f.readBlock("{","}")}var E=o(g.substr(0,g.length-1),l+1,1).join("\n")+"}";m==="h"?p.push("function "+E.substr(7)):m==="s"?d.push("function _section_"+E.substr(8)):h.push(E)}else if(m&&!n.test(r(v.value))){var S,x;g="";for(;;){S=f.text.substr(f.position+1),x=S.match(n);if(!x)break;g+=f.read(x[0].length),m=f.peek();if(m==="["||m==="(")g+=f.readBlock(m,m==="["?"]":")")}g&&h.push(g,1)}else c===0&&v.next&&h.push("@",2)}return l>0?h:(e=h.map(function(e){return i.prototype.toString.apply(e)}).join("\r\n"),e=s.replace("#0",e).replace("#1",p.map(u).join("\r\n")).replace("#2",d.map(u).join("\r\n")),e)}function u(e){var t=e.indexOf("{");return e.substr(0,t+1)+"\r\n"+e.substring(t+1,e.lastIndexOf("}"))+'; return ""; }'}function a(e){return e.split("\r").join("\\r").split("\n").join("\\n").split('"').join('\\"')}function f(e){return{toString:function(){return e},isHtmlString:!0}}function h(e,t,n){var r,i=o(e,n);try{r=new Function(i)}catch(s){throw global.console.error(s.message+": "+i),s.message+": "+i}return function(e,n){var i=p({},c,t,n,{model:e});return r.apply(i)}}function p(e){for(var t=1,n=arguments.length;t<n;t++){var r=arguments[t];if(r)for(var i in r)r.hasOwnProperty(i)&&(e[i]=r[i])}return e}function g(t,n){var r=v["~/"+t];if(!!r)return m?d().resolve(r):r;var i=e.findView(t);if(i instanceof d){m=!0;var s=d();return i.done(function(i){i&&(r=v["~/"+t]=e.compile(i,n)),s.resolve(r)}),s}if(i)return v["~/"+t]=e.compile(i,n)}var e,t=function(){function n(e,n,i){function l(t){return s=t.length,f=o[s]||(o[s]=e.peek(s)),f===t}var s,o=[],u=n.length,a="",f="";for(;;){o.length=0;if(i===n.some(l))return i?e.seek(s):(f=r(a),a=a.length>0?a.substr(0,a.length-1):""),new t(a,f);f=e.read();if(!f)break;a+=f}return new t(a,f)}var e=function(e){this.text=(e||"")+"",this.position=-1,this.length=this.text.length},t=e.Chunk=function(e,t){this.value=e||"",this.next=t||"",this.length=(this.value+this.next).length};return p(t.prototype,{length:0,toString:function(){return this.value+this.next+""}}),e.prototype.read=function(e){var t=this.peek(e);return this.position=Math.min(this.length,this.position+(e||1)),t},e.prototype.readAll=function(){if(this.position>=this.length)return undefined;var e=this.text.substr(this.position+1);return this.position=this.length,e},e.prototype.peek=function(e){return this.position+1>=this.length?undefined:this.text.substr(this.position+1,e||1)},e.prototype.seek=function(e,t){return this.position=Math.max(0,Math.min(this.length,(t===0?0:t===2?this.length:this.position)+(e||1))),this.position===this.length},e.prototype.readUntil=function(e){return typeof e=="string"&&(e=[].slice.call(arguments)),n(this,e,!0)},e.prototype.readWhile=function(e){return typeof e=="string"&&(e=[].slice.call(arguments)),n(this,e,!1)},e}(),n=/^[a-z0-9\._]+/i;t.prototype.readWhitespace=function(){return this.readWhile("\r","\n","	"," ")},t.prototype.readQuoted=function(e){var t="",n;for(;;){n=this.readUntil(e);if(!n)break;t+=n.value+n.next;if(r(n.value)!=="\\")break}return t},t.prototype.readQuotedUntil=function(e){var n="",r;typeof e=="string"&&(e=[].slice.call(arguments)),e=['"',"'","@*"].concat(e);while(r=this.readUntil(e)){n+=r.value;if(r.next==='"'||r.next==="'")n+=r.next+this.readQuoted(r.next);else{if(r.next!=="@*")break;this.readUntil("*@")}}return new t.Chunk(n,r.next)},t.prototype.readBlock=function(e,t,n){var r,i=[e,t],s="";n=n||0;while(r=this.readUntil(i)){s+=r.value,r.next===e?n++:r.next===t&&n--;if(n===0)return s+=r.next,s;s+=r.next}return s};var i=function(e,t){this.code=e||"",this.type=t||0};p(i.prototype,{type:0,code:"",toString:function(){var e=this.code;return this.type===0?e:this.type===2?'writeLiteral("'+a(e)+'");':"write("+e+");"}});var s='var page = this, writer = [], model = page.model, html = page.html; \r\nfunction write(txt){ writeLiteral(page.html.encode(txt)); }\r\nfunction writeLiteral(txt){ writer.push(txt); }\r\n#1\r\n#2\r\n#0\r\nreturn writer.join("");',l={encode:function(e){if(e===null||e===undefined)e="";return e.isHtmlString?e:(typeof e!="string"&&(e+=""),e=e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;"),l.raw(e))},attributeEncode:function(e){return l.encode(e)},raw:function(e){return f(e)},renderPartial:function(t,n){return this.raw(e.view(t)(n))}},c={html:l},d=function y(){if(!(this instanceof y))return new y;var e=[],t=[],n=[],r=0,i=this,s,o=function(e,t){var n;while(t&&(n=e.shift()))n.apply(i,s)};p(i,{done:function(n){return n&&e.push(n),o(e,r===1),o(t,r!==0),i},always:function(e){return t.push(e),o(t,r!==0),i},fail:function(e){return e&&n.push(e),o(n,r===-1),o(t,r!==0),i},resolve:function(){return s=arguments,r===0&&(r=1),i.done()},reject:function(){return s=arguments,r===0&&(r=-1),i.fail()}})},v={},m=!1;e={view:g,compile:h,parse:o,findView:null,basePage:c,render:function(e,t,n){return h(e,n)(t)}},e.findView=function(t){var n=require("fs"),r=d();return t.substring(t.lastIndexOf("."))!==".jshtml"&&(t+=".jshtml"),n.readFile(t,"ascii",function(e,t){e&&(console.error("Could not open file: %s",e),process.exit(1)),r.resolve(t.toString("ascii"))}),r}})(module)