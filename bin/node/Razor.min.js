/*
  razorjs 0.1.0 <https://github.com/andyedinborough/RazorJS>
  Copyright (c) 2013 Andy Edinborough (@andyedinborough)

  Released under MIT License
*/
(function(e,t){function n(e){if(e&&(e+"").indexOf("[native code]")>-1)return e}function f(e){return i(arguments,function(t,n){if(n===0)return;t&&i(a(t),function(n){e[n]=t[n]})}),e}function c(e){var t=e.indexOf("{");return e.substr(0,t+1)+"\r\n"+e.substring(t+1,e.lastIndexOf("}"))+'; return ""; }'}function h(e){return e.split("\r").join("\\r").split("\n").join("\\n").split('"').join('\\"')}function p(e){return{toString:function(){return e},isHtmlString:!0}}function g(e){return(e=e||"").substr(e.length-1)}function w(e){var t=new d(e),n=arguments[1]||0,r=arguments[2]||0,i=[],o=[],u=[],a,f,l,h=function(){f=t.peek();if(f==="*")t.readUntil("*@");else if(f==="(")l=t.readBlock("(",")"),i.push(l.substr(1,l.length-2),1);else if(f==="{")l=t.readBlock("{","}"),i.push(w(l.substr(1,l.length-2),n+1,1).join("\n"));else if(f===":"&&r===1){l=t.readUntil("\n","@","}");while(l.next==="@"&&t.peek()==="@"){var e=t.readUntil("\n","@","}");l.value+=e.value,l.next=e.next}t.seek(-1),l.value=l.value.substr(1),i.push(l.value,2)}else if(f==="i"&&t.peek(2)==="if"||f==="d"&&t.peek(2)==="do"||f==="f"&&t.peek(3)==="for"||f==="w"&&t.peek(5)==="while"||f==="h"&&t.peek(6)==="helper"||f==="s"&&t.peek(7)==="section"){l=t.readBlock("{","}");if(f==="i")while(!t.eof()){var s=t.readWhitespace();if(!s)break;if(t.peek(4)!=="else"){t.seek(-s.length);break}l+=s+t.readBlock("{","}")}var c=w(l.substr(0,l.length-1),n+1,1).join("\n")+"}";f==="h"?o.push("function "+c.substr(7)):f==="s"?u.push("function _section_"+c.substr(8)):i.push(c)}else if(f&&!v.test(g(a.value))){var h,p;l="";while(!t.eof()){h=t.text.substr(t.position+1),p=h.match(v);if(!p)break;l+=t.read(p[0].length),f=t.peek();if(!f)break;if(f==="["||f==="("){l+=t.readBlock(f,f==="["?"]":")");break}}l&&i.push(l,1)}else r===0&&a.next&&i.push("@",2)};i.push=function(e){return function(t,n){typeof t=="string"&&(t=[t]),t=s(t,function(e){return typeof e.code!="undefined"?e:new y(e,n)}),e.apply(this,t)}}(i.push);while(!t.eof()){a=r===0?t.readUntil("@"):t.readQuotedUntil("@","<");if(!a)break;for(;;){f=t.peek(),f==="@"&&(a.value+=t.read());if(r===1&&a.next==="<"){var p=!1,E=(t.text.substr(t.position+1,30).match(m)||0)[0]||"";if(!E){var T=t.readQuotedUntil("@","<");a.value+=a.next+T.value,a.next=T.next;continue}i.push(a.value,0);while(!t.eof()){a=t.readUntil("@",">");if(a.next!="@")break;i.push("<"+a.value,2),p=!0,h()}l=a+"";if(g(a.value)!=="/"){var S=1,x;while(S>0){x=t.readQuotedUntil(["</"+E,"<"+E]),l+=x;if(t.eof())break;S+=x.next.substr(1,1)==="/"?-1:1}l+=t.readQuotedUntil(">")}p||(E==="text"?l=l.substr(5,l.length-5-7):l="<"+l),i.push(w(l,n+1,0))}else a.value&&(r===0?i.push(a.value,2):i.push(a.value));break}h()}return n>0?i:(e=i.join("\r\n"),e=b.replace("#0",e).replace("#1",s(o,c).join("\r\n")).replace("#2",s(u,c).join("\r\n")),e)}function x(t,n){var r,i=w(t);try{r=new Function(i)}catch(s){throw e.console.error(s.message+": "+i),s.message+": "+i}return function(e,t){var i=f(t||{},S,n,{model:e,writer:[]});return r.apply(i)}}function C(e,t){var n=T["~/"+e];if(!!n)return N?l().resolve(n):n;var r=Razor.findView(e);if(!r)return;if(typeof r.done=="function"){N=!0;var i=l();return r.done(function(r){r&&(n=T["~/"+e]=Razor.compile(r,t)),i.resolve(n)}),i}if(r)return T["~/"+e]=Razor.compile(r,t)}var r=function(e){return function(t,n){return e.apply(t,[n])}},i=r(n(Array.prototype.forEach)||function(t,n){var r=this.length,i=r,s,o=n||e;while(i--)t.apply(o,[this[s=r-i-1],s])}),s=r(n(Array.prototype.map)||function(t,n){var r=n||e,i=[];for(var s=0,o=this.length;s<o;++s)i.push(t.call(r,this[s],s,this));return i}),o=r(n(Array.prototype.some)||function(t,n){var r=n||e;for(var i=0,s=this.length;i<s;++i)if(t.call(r,this[i],i,this))return!0;return!1}),u="toString valueOf".split(" "),a=n(Object.keys)||function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return i(u,function(n){e[n]!==Object.prototype[n]&&t.push(n)}),t},l=function k(){if(!(this instanceof k))return new k;var e=[],t=[],n=[],r=0,i=this,s,o=function(e,t){var n;while(t&&(n=e.shift()))n.apply(i,s)};f(i,{done:function(n){return n&&e.push(n),o(e,r===1),o(t,r!==0),i},always:function(e){return t.push(e),o(t,r!==0),i},fail:function(e){return e&&n.push(e),o(n,r===-1),o(t,r!==0),i},resolve:function(){return s=arguments,r===0&&(r=1),i.done()},reject:function(){return s=arguments,r===0&&(r=-1),i.fail()}})},d=function(){function r(e,t,r){function f(t){return i=t.length,a=s[i]||(s[i]=e.peek(i)),a===t}var i,s=[],u="",a="";while(!e.eof()){s.length=0;if(r===o(t,f))return r?e.seek(i):(a=g(u),u=u.length>0?u.substr(0,u.length-1):""),n.create(u,a);a=e.read();if(!a)break;u+=a}return n.create(u,a)}var e=function(e){this.text=(e||"")+"",this.position=-1,this.length=this.text.length},n=e.Chunk=function(e,t){this.value=e||"",this.next=t||"";if(!e&&!t)return"";this.length=(this.value+this.next).length};return f(n.prototype,{length:0,toString:function(){return this.value+this.next+""}}),n.create=function(e,t){return!e&&!t?"":new n(e,t)},f(e.prototype,{eof:function(){return this.position>=this.length},read:function(e){var t=this.peek(e);return this.position=Math.min(this.length,this.position+(e||1)),t},readAll:function(){if(this.position>=this.length)return t;var e=this.text.substr(this.position+1);return this.position=this.length,e},peek:function(e){return this.position+1>=this.length?t:this.text.substr(this.position+1,e||1)},seek:function(e,t){return this.position=Math.max(0,Math.min(this.length,(t===0?0:t===2?this.length:this.position)+(e||1))),this.position===this.length},readUntil:function(e){return typeof e=="string"&&(e=[].slice.call(arguments)),r(this,e,!0)},readWhile:function(e){return typeof e=="string"&&(e=[].slice.call(arguments)),r(this,e,!1)}}),e}(),v=/^[a-z0-9\._]+/i,m=/^[a-z]+(?:\:[a-z]+)?/i;d.prototype.readWhitespace=function(){return this.readWhile("\r","\n","	"," ")},d.prototype.readQuoted=function(e){var t="",n;for(;;){n=this.readUntil(e);if(!n)break;t+=n.value+n.next;if(g(n.value)!=="\\")break}return t},d.prototype.readQuotedUntil=function(e){var t="",n;typeof e=="string"&&(e=[].slice.call(arguments)),e=['"',"'","@*"].concat(e);while(!!(n=this.readUntil(e))){t+=n.value;if(n.next==='"'||n.next==="'")t+=n.next+this.readQuoted(n.next);else{if(n.next!=="@*")break;this.readUntil("*@")}}return d.Chunk.create(t,n.next)},d.prototype.readBlock=function(e,t,n){var r,i=[e,t],s="";n=n||0;while(!!(r=this.readUntil(i))){s+=r.value,r.next===e?n++:r.next===t&&n--;if(n===0)return s+=r.next,s;s+=r.next}return s};var y=function(e,t){this.code=e||"",this.type=t||0};f(y.prototype,{type:0,code:"",toString:function(){var e=this.code;return this.type===0?e:this.type===2?'page.writeLiteral("'+h(e)+'");':"page.write("+e+");"}});var b='var page = this, writer = page.writer, model = page.model, html = page.html;\n#1\n#2\n#0\nreturn writer.join("");',E={encode:function(e){if(e===null||e===t)e="";return e.isHtmlString?e:(typeof e!="string"&&(e+=""),e=e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;"),E.raw(e))},attributeEncode:function(e){return E.encode(e)},raw:function(e){return p(e)},renderPartial:function(e,t){return this.raw(Razor.view(e)(t))}},S={html:E,write:function(e){this.writeLiteral(this.html.encode(e))},writeLiteral:function(e){this.writer.push(e)}},T={},N=!1;Razor={view:C,compile:x,parse:w,findView:null,basePage:S,Cmd:y,render:function(e,t,n){return x(e)(t,n)}},Razor.findView=function(t){var n=require("fs"),r=l();return t.substring(t.lastIndexOf("."))!==".jshtml"&&(t+=".jshtml"),n.readFile(t,"ascii",function(e,t){e&&(console.error("Could not open file: %s",e),process.exit(1)),r.resolve(t.toString("ascii"))}),r},module.Razor=module.exports.Razor=Razor})(module);